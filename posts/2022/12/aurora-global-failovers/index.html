<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Aurora Global Failovers - MySQL and Infrastructure by Jay Janssen</title><meta name=Description content="MySQL and Infrastructure"><meta property="og:title" content="Aurora Global Failovers"><meta property="og:description" content="As part of an overwhelming stampede to migrate to the cloud, we are looking at using AWS RDS Aurora MySQL as a platform for some of our database clusters. Lots of people have lots of opinions about Aurora, some of them are probably justified and some probably not.
I was interested in testing the high availability and disaster recovery capabilities of Aurora. To be specific, I am testing Aurora v2 (though I expect v3 to work the same)."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-02T08:17:57-05:00"><meta property="article:modified_time" content="2022-12-02T08:17:57-05:00"><meta property="og:site_name" content="MySQL and Infrastructure by Jay Janssen"><meta name=twitter:card content="summary"><meta name=twitter:title content="Aurora Global Failovers"><meta name=twitter:description content="As part of an overwhelming stampede to migrate to the cloud, we are looking at using AWS RDS Aurora MySQL as a platform for some of our database clusters. Lots of people have lots of opinions about Aurora, some of them are probably justified and some probably not.
I was interested in testing the high availability and disaster recovery capabilities of Aurora. To be specific, I am testing Aurora v2 (though I expect v3 to work the same)."><meta name=application-name content="MySQL and Infrastructure by Jay Janssen"><meta name=apple-mobile-web-app-title content="MySQL and Infrastructure by Jay Janssen"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/><link rel=prev href=http://blog.jayjanssen.net/posts/2022/11/back-in-the-saddle/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Aurora Global Failovers","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.jayjanssen.net\/posts\/2022\/12\/aurora-global-failovers\/"},"genre":"posts","wordcount":1284,"url":"http:\/\/blog.jayjanssen.net\/posts\/2022\/12\/aurora-global-failovers\/","datePublished":"2022-12-02T08:17:57-05:00","dateModified":"2022-12-02T08:17:57-05:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Jay Janssen"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="MySQL and Infrastructure by Jay Janssen">blog.jayjanssen.net</a></div><div class=menu><div class=menu-inner><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="MySQL and Infrastructure by Jay Janssen">blog.jayjanssen.net</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated">Aurora Global Failovers</h1><div class=post-meta><div class=post-meta-line></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-02>2022-12-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1284 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#aurora-global-clusters>Aurora Global Clusters</a></li><li><a href=#aurora-endpoints>Aurora Endpoints</a></li><li><a href=#planned-failover-aka-switchover>Planned Failover (aka Switchover)</a></li><li><a href=#unplanned-failover>Unplanned Failover</a></li><li><a href=#what-aws-states-about-failover>What AWS states about Failover</a></li></ul></nav></div></div><div class=content id=content><p>As part of an overwhelming stampede to migrate to the cloud, we are looking at using <em>AWS RDS Aurora MySQL</em> as a platform for some of our database clusters. Lots of people have lots of opinions about Aurora, some of them are probably justified and some probably not.</p><p>I was interested in testing the high availability and disaster recovery capabilities of Aurora. To be specific, I am testing Aurora v2 (though I expect v3 to work the same). I am also specifically testing <a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database.html target=_blank rel="noopener noreffer">Aurora Global databases</a></p><h2 id=aurora-global-clusters>Aurora Global Clusters</h2><p>Aurora global databases are relatively simple to understand. Perhaps the best way is to describe it in the order in which you would construct it:</p><ol><li>Create your first regional cluster</li><li>Create a global cluster from the first cluster</li><li>Create replica clusters in other regions</li></ol><figure><img src=https://docs.aws.amazon.com/images/AmazonRDS/latest/AuroraUserGuide/images/aurora-global-databases-conceptual-illo.png><figcaption><p><a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database.html>Using Aurora global databases, User Guide for Aurora, AWS Documentation</a></p></figcaption></figure><p>Only one cluster can take writes at a time, and it is designated as the <em>Primary cluster</em>. The other cluster(s) are considered <em>Secondary</em>. Replication across region is done by the Storage layer and <em>does not</em> use standard MySQL replication.</p><h2 id=aurora-endpoints>Aurora Endpoints</h2><p>Another important concept to understand is <a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Overview.Endpoints.html target=_blank rel="noopener noreffer">Aurora endpoints</a>. Each cluster (in each region) has two default endpoints, a writer and a reader. The writer points to the currently primary writer instance and the reader points to all the reader instance(s) as you might expect. These endpoints are how your client would connect to the Aurora cluster and they automatically follow when instance roles changes, for example if Writer instance failed over to another in-region.</p><p>Each instance in the cluster also have their own direct endpoints, but use of these is not recommended since instance roles can change automatically.</p><p>In global clusters, endpoints still exist for each regional cluster. There is no concept of a global endpoint. Whichever cluster is the Primary has it&rsquo;s Writer endpoint active. Secondary cluster&rsquo;s have inactive Writer endpoints. To be specific, the endpoint on a secondary cluster has the <em>Inactive</em> status and the name cannot be resolved in DNS.</p><figure><img src=endpoints-in-a-secondary-cluster.png alt="The writer endpoint is inactive in this secondary cluster"><figcaption><p>The writer endpoint is inactive in this secondary cluster</p></figcaption></figure><p>Ergo, the application must be aware of the endpoints in it&rsquo;s deployment region. If the application is active in the non-primary Aurora region, it must somehow be aware of the endpoint in the Primary region or else not allow writes to the Aurora cluster. To be fair, there is an Aurora feature for <a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database-write-forwarding.html target=_blank rel="noopener noreffer">Global Database Write forwarding</a> that I have not experimented much with yet.</p><h2 id=planned-failover-aka-switchover>Planned Failover (aka Switchover)</h2><p>Now that we have our shiny global cluster, let&rsquo;s test failover! AWS calls this <em>planned failover</em>, though hopefully there isn&rsquo;t much failure involved. Our goal is to safely change which cluster is primary without any dataloss and (hopefully) not a lot of application downtime.</p><p>This action can be taken from the AWS console with the &lsquo;Fail over global database&rsquo; action on the Global database object, or else via the AWS rds CLI. Anyone who has done mysql primary switchovers ever should be familiar with the basic steps here:</p><ol><li>Set the old primary read-only</li><li>Wait for replication to catch up</li><li>Set the new primary read-write</li></ol><p>Aurora is no exception, but there are a few additional steps. Because the new primary cluster&rsquo;s writer endpoint is Inactive, it must be made active.</p><p>To test this, I connect a <code>sysbench</code> client to my primary cluster&rsquo;s endpoint. Because there is no global endpoint, I have to pay attention to when the secondary cluster&rsquo;s endpoint becomes available in DNS so I can reconnect my client to it instead. However, I have discovered that</p><p>Here is a representative sample of the timings of my operations:</p><table><thead><tr><th>Time</th><th>Action / Event</th></tr></thead><tbody><tr><td>00:00</td><td>Failover started</td></tr><tr><td>02:19</td><td>Writes cease in primary</td></tr><tr><td>02:38</td><td>Reads case on primary endpoint</td></tr><tr><td>05:05</td><td>Writes start on new primary cluster&rsquo;s <em>instance</em> endpoint</td></tr><tr><td>14:19</td><td>The writer endpoint resolves in DNS</td></tr></tbody></table><p>From these timings, we can see clearly that the global failover operation is really supposed to finish around the 5 minute mark (after approximately 3 minutes of write downtime). Around this time, I can see the AWS console indicating that the new primary cluster&rsquo;s writer endpoint indicates it is in the <em>Available</em> state, yet it does not resolve in DNS.</p><p>I have tested this many times, and to be fair it is not always this slow. I have observed the writer endpoint resolving in DNS much sooner than it did in my example here. I believe this is an AWS <em>bug</em> and AWS claims they will be fixing it soon.</p><div class="details admonition bug open"><div class="details-summary admonition-title"><i class="icon fas fa-bug fa-fw" aria-hidden=true></i>Bug<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>In my testing (as of December 2022) write downtime can currently take anywhere from <strong>3-15 minutes</strong>. Even when this DNS propogation bug is fixed (assuming that&rsquo;s what it is), I expect that the best that can be expected for writer downtime will be approximately <strong>3-5 minutes</strong>.</div></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Anyone who needs to run routine DR testing on Aurora Global clusters will want to strongly consider doing so off-peak hours</div></div></div><h2 id=unplanned-failover>Unplanned Failover</h2><p><a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database-disaster-recovery.html#aurora-global-database-failover target=_blank rel="noopener noreffer">Amazon&rsquo;s unplanned failover documentation</a> is pretty interesting in the sense that they explicitly tell you <em>not to use the failover button</em> that you use for Planned failovers. Instead the steps can be summarized as such:</p><ol><li>Stop writing to your primary db (assuming their primary region is available enough that you can reach your application).</li><li>Pick your target cluster to failover to</li><li>Remove the target cluster from the global database</li><li>Start writing to the new target cluster.</li></ol><p>Step 3 effectively splits the target cluster such that you now have two database clusters. Depending on the severity of the AWS region outage, you may or may not be able to do any of the following:</p><ul><li>See if your primary cluster is up at all and taking writes</li><li>Take some kind of action to ensure said primary cluster is not taking writes any more</li><li>Execute any kind of reasonable STONITH/fencing procedures.</li></ul><p>Based on the fact that AWS recommends against using it, it also that the &ldquo;Failover&rdquo; action for global databases is not trustworthy enough to even attempt to execute in the event of a primary region failure and so you have to take an alternative process in the event of a true failure. Personally, I&rsquo;d prefer if something at least <em>tried</em> to execute the proper failover steps in case the outage is intermittent enough to occasionally be able to reach the region/cluster experiencing the problem.</p><p>As far as the observed time to execute an Unplanned failover, detaching the secondary cluster is a relatively fast operation. In that situation, nothing is setting the primary cluster read-only nor waiting for replication lag to catch up (at least in the sense that it can confirm all writes from the old primary have made it to the new). However, the same DNS propogation issue exists in this scenario that will delay the availability of the writer endpoint. Therefore, once this process is executed, I estimate it takes around 2-14 minutes or 2-4 minutes once the bug is fixed.</p><h2 id=what-aws-states-about-failover>What AWS states about Failover</h2><p>In short, the manual seems to acknowledge that &ldquo;minutes&rdquo; is to be expected:</p><div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fas fa-quote-right fa-fw" aria-hidden=true></i>Quote<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>For an Aurora global database, RTO can be in the order of minutes.
<a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database-disaster-recovery.html#aurora-global-database-failover target=_blank rel="noopener noreffer">source</a></div></div></div><p>While related marketing content seems to paint a rosier picture:<div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fas fa-quote-right fa-fw" aria-hidden=true></i>Quote<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>If your primary Region suffers a performance degradation or outage, you can promote one of the secondary Regions to take read/write responsibilities. An Aurora cluster can recover in less than 1 minute even in the event of a complete Regional outage. This provides your application with an effective Recovery Point Objective (RPO) of 1 second and a Recovery Time Objective (RTO) of less than 1 minute, providing a strong foundation for a global business continuity plan.
<a href=https://aws.amazon.com/rds/aurora/global-database/ target=_blank rel="noopener noreffer">source</a></div></div></div></p><p>If you find any other public statements, I&rsquo;d be happy to hear about them!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/ data-title="Aurora Global Failovers"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://blog.jayjanssen.net/posts/2022/12/aurora-global-failovers/ data-title="Aurora Global Failovers"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2022/11/back-in-the-saddle/ class=prev rel=prev title="Back in the Saddle"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Back in the Saddle</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Jay Janssen</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://blog-jayjanssen-net.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:100,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>